name: Deploy Memberships System

on:
  push:
    branches:
      - main
    paths:
      - 'dashboard-redjudicial.php'
      - 'functions.php'
      - 'verificar_sistema.php'
      - 'productos_woo.sql'

jobs:
  deploy-memberships:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy memberships files
        run: |
          echo "üöÄ Iniciando deploy del sistema de membres√≠as..."
          
          # Crear directorio temporal en el servidor
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            mkdir -p /home/bitnami/memberships-deploy
          "
          
          # Subir archivos de membres√≠as
          scp -o StrictHostKeyChecking=no \
            dashboard-redjudicial.php \
            functions.php \
            verificar_sistema.php \
            productos_woo.sql \
            bitnami@23.22.241.121:/home/bitnami/memberships-deploy/

      - name: Install memberships system
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üìÅ Instalando sistema de membres√≠as...'
            
            # Verificar que WordPress est√© disponible
            if [ ! -d '/opt/bitnami/wordpress' ]; then
              echo '‚ùå WordPress no encontrado en /opt/bitnami/wordpress'
              exit 1
            fi
            
            # Obtener el tema activo
            cd /opt/bitnami/wordpress
            ACTIVE_THEME=\$(wp theme list --status=active --format=csv --fields=name | tail -n +2 | head -n 1)
            echo \"üé® Tema activo: \$ACTIVE_THEME\"
            
            if [ -z \"\$ACTIVE_THEME\" ]; then
              echo '‚ö†Ô∏è No se pudo determinar el tema activo, usando twentytwentyfour'
              ACTIVE_THEME='twentytwentyfour'
            fi
            
            THEME_DIR=\"/opt/bitnami/wordpress/wp-content/themes/\$ACTIVE_THEME\"
            echo \"üìÅ Directorio del tema: \$THEME_DIR\"
            
            # Crear backup del functions.php existente
            if [ -f \"\$THEME_DIR/functions.php\" ]; then
              cp \"\$THEME_DIR/functions.php\" \"\$THEME_DIR/functions.php.backup.\$(date +%Y%m%d_%H%M%S)\"
              echo 'üíæ Backup del functions.php creado'
            fi
            
            # Copiar archivos al tema
            cp /home/bitnami/memberships-deploy/dashboard-redjudicial.php \"\$THEME_DIR/\"
            cp /home/bitnami/memberships-deploy/verificar_sistema.php \"\$THEME_DIR/\"
            
            # Agregar funciones al functions.php
            echo 'üìù Agregando funciones de membres√≠as al functions.php...'
            cat /home/bitnami/memberships-deploy/functions.php >> \"\$THEME_DIR/functions.php\"
            
            # Ajustar permisos
            sudo chown -R bitnami:daemon \"\$THEME_DIR/\"
            chmod 644 \"\$THEME_DIR/dashboard-redjudicial.php\"
            chmod 644 \"\$THEME_DIR/verificar_sistema.php\"
            chmod 644 \"\$THEME_DIR/functions.php\"
            
            echo '‚úÖ Archivos de membres√≠as instalados'
          "

      - name: Execute SQL for products
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üóÑÔ∏è Ejecutando SQL para crear productos...'
            
            cd /opt/bitnami/wordpress
            
            # Verificar que MySQL est√© disponible
            if ! mysql -u root -p\$MYSQL_ROOT_PASSWORD -e 'SELECT 1' >/dev/null 2>&1; then
              echo '‚ùå No se puede conectar a MySQL'
              exit 1
            fi
            
            # Obtener nombre de la base de datos
            DB_NAME=\$(wp config get DB_NAME)
            echo \"üìä Base de datos: \$DB_NAME\"
            
            # Ejecutar SQL
            mysql -u root -p\$MYSQL_ROOT_PASSWORD \"\$DB_NAME\" < /home/bitnami/memberships-deploy/productos_woo.sql
            
            echo '‚úÖ Productos creados en WooCommerce'
          "

      - name: Create required pages
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'ÔøΩÔøΩ Creando p√°ginas requeridas...'
            
            cd /opt/bitnami/wordpress
            
            # Lista de p√°ginas a crear
            PAGES=(
              'foros-debates:Foros y Debates'
              'noticias:Noticias'
              'webinars-generales:Webinars Generales'
              'agenda-judicial:Agenda Judicial'
              'webinars-especializados:Webinars Especializados'
              'base-semantica:Base Sem√°ntica'
              'marketplace:Marketplace'
              'dashboard-centralizado:Dashboard Centralizado'
              'simuladores-examenes:Simuladores de Ex√°menes'
              'ranking-estudiantes:Ranking de Estudiantes'
            )
            
            for page in \"\${PAGES[@]}\"; do
              IFS=':' read -r slug title <<< \"\$page\"
              
              # Verificar si la p√°gina ya existe
              if ! wp post list --post_type=page --name=\"\$slug\" --format=count >/dev/null 2>&1; then
                echo \"üìÑ Creando p√°gina: \$title (\$slug)\"
                wp post create --post_type=page --post_title=\"\$title\" --post_name=\"\$slug\" --post_status=publish --post_content=\"Contenido de \$title\"
              else
                echo \"‚úÖ P√°gina ya existe: \$title\"
              fi
            done
            
            echo '‚úÖ P√°ginas creadas/verificadas'
          "

      - name: Clear WordPress cache
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üßπ Limpiando cache de WordPress...'
            
            cd /opt/bitnami/wordpress
            
            # Limpiar cache de plugins
            wp cache flush 2>/dev/null || echo '‚ö†Ô∏è No se pudo limpiar cache de WordPress'
            
            # Limpiar cache de archivos
            sudo rm -rf /opt/bitnami/wordpress/wp-content/cache/* 2>/dev/null || true
            sudo rm -rf /opt/bitnami/wordpress/wp-content/uploads/cache/* 2>/dev/null || true
            
            # Reiniciar servicios
            sudo /opt/bitnami/ctlscript.sh restart apache 2>/dev/null || true
            sudo /opt/bitnami/ctlscript.sh restart nginx 2>/dev/null || true
            
            echo '‚úÖ Cache limpiado y servicios reiniciados'
          "

      - name: Verify installation
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üîç Verificando instalaci√≥n del sistema de membres√≠as...'
            
            cd /opt/bitnami/wordpress
            
            # Verificar archivos
            echo 'üìÅ Verificando archivos:'
            ls -la wp-content/themes/*/dashboard-redjudicial.php 2>/dev/null || echo '‚ùå dashboard-redjudicial.php no encontrado'
            ls -la wp-content/themes/*/verificar_sistema.php 2>/dev/null || echo '‚ùå verificar_sistema.php no encontrado'
            
            # Verificar productos
            echo 'üì¶ Verificando productos:'
            wp post list --post_type=product --format=table --fields=ID,post_title,post_name 2>/dev/null || echo '‚ùå No se pudieron listar productos'
            
            # Verificar p√°ginas
            echo 'üìÑ Verificando p√°ginas:'
            wp post list --post_type=page --format=table --fields=ID,post_title,post_name | grep -E '(foros|noticias|webinars|agenda|base|marketplace|simuladores|ranking)' || echo '‚ö†Ô∏è Algunas p√°ginas no encontradas'
            
            echo '‚úÖ Verificaci√≥n completada'
          "

      - name: Cleanup
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üßπ Limpiando archivos temporales...'
            rm -rf /home/bitnami/memberships-deploy
            echo '‚úÖ Limpieza completada'
          "

      - name: Final verification
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üéâ === DEPLOY DE MEMBRES√çAS COMPLETADO ==='
            echo '‚úÖ Sistema de membres√≠as instalado'
            echo '‚úÖ 6 productos WooCommerce creados'
            echo '‚úÖ P√°ginas requeridas creadas'
            echo '‚úÖ Dashboard √∫nico configurado'
            echo '‚úÖ Funciones de filtrado activas'
            echo ''
            echo 'üìã Pr√≥ximos pasos:'
            echo '1. Crear planes de membres√≠a en WooCommerce Memberships'
            echo '2. Configurar grupos en BuddyBoss'
            echo '3. Configurar pasarela de pagos (Flow)'
            echo '4. Probar flujo de compra y suscripciones'
          "
