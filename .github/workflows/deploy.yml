name: Deploy Landing to Lightsail

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Verify files exist before deployment
        run: |
          echo "üîç Verificando archivos antes del deploy..."
          echo "üìÅ Archivos principales:"
          ls -la *.html *.css *.js *.png 2>/dev/null || echo "‚ö†Ô∏è Algunos archivos principales no encontrados"
          echo "üìÅ Archivos de noticias:"
          ls -la noticias.html css/noticias.css js/noticias.js 2>/dev/null || echo "‚ö†Ô∏è Algunos archivos de noticias no encontrados"
          echo "üìÅ Estructura de directorios:"
          find . -name "*.html" -o -name "*.css" -o -name "*.js" | head -20

      - name: Deploy landing files via SCP
        run: |
          echo "üì§ Desplegando archivos principales..."
          scp -o StrictHostKeyChecking=no \
            index.html \
            estudiantes.html \
            noticias.html \
            script.js \
            styles.css \
            estudiantes.css \
            chat-widget.js \
            server.js \
            package.json \
            package-lock.json \
            test-deployment.txt \
            logo-original.png \
            isotipo-small.png \
            bitnami@23.22.241.121:/home/bitnami/landing/

      - name: Deploy noticias files via SCP
        run: |
          echo "üì§ Desplegando archivos de noticias..."
          # Crear directorios en servidor si no existen
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            mkdir -p /home/bitnami/landing/css /home/bitnami/landing/js
          "
          # Copiar archivos de noticias
          scp -o StrictHostKeyChecking=no \
            css/noticias.css \
            bitnami@23.22.241.121:/home/bitnami/landing/css/
          scp -o StrictHostKeyChecking=no \
            js/noticias.js \
            bitnami@23.22.241.121:/home/bitnami/landing/js/

      - name: Copy files to WordPress directory
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üìÅ Archivos en landing:' &&
            ls -la /home/bitnami/landing/*.css &&
            echo 'üìÅ Archivos de noticias en landing:' &&
            ls -la /home/bitnami/landing/css/ /home/bitnami/landing/js/ 2>/dev/null || echo '‚ö†Ô∏è Directorios de noticias no encontrados' &&
            echo 'üìÅ Copiando archivos principales...' &&
            sudo cp /home/bitnami/landing/index.html /opt/bitnami/apache/htdocs/ &&
            sudo cp /home/bitnami/landing/estudiantes.html /opt/bitnami/apache/htdocs/ &&
            sudo cp /home/bitnami/landing/noticias.html /opt/bitnami/apache/htdocs/ &&
            sudo cp /home/bitnami/landing/*.css /opt/bitnami/apache/htdocs/ &&
            sudo cp /home/bitnami/landing/*.js /opt/bitnami/apache/htdocs/ &&
            sudo cp /home/bitnami/landing/*.png /opt/bitnami/apache/htdocs/ 2>/dev/null || echo '‚ö†Ô∏è Algunos archivos PNG no encontrados' &&
            echo 'üìÅ Copiando archivos de noticias a Apache...' &&
            sudo mkdir -p /opt/bitnami/apache/htdocs/css /opt/bitnami/apache/htdocs/js &&
            sudo cp -r /home/bitnami/landing/css/* /opt/bitnami/apache/htdocs/css/ 2>/dev/null || echo '‚ö†Ô∏è No se pudieron copiar archivos CSS de noticias' &&
            sudo cp -r /home/bitnami/landing/js/* /opt/bitnami/apache/htdocs/js/ 2>/dev/null || echo '‚ö†Ô∏è No se pudieron copiar archivos JS de noticias' &&
            sudo chown -R bitnami:daemon /opt/bitnami/apache/htdocs/ &&
            echo 'üìÅ Copiando TAMBI√âN a WordPress (para redjudicial.cl)...' &&
            sudo cp /home/bitnami/landing/index.html /opt/bitnami/wordpress/ &&
            sudo cp /home/bitnami/landing/estudiantes.html /opt/bitnami/wordpress/ &&
            sudo cp /home/bitnami/landing/noticias.html /opt/bitnami/wordpress/ &&
            sudo cp /home/bitnami/landing/*.css /opt/bitnami/wordpress/ &&
            sudo cp /home/bitnami/landing/*.js /opt/bitnami/wordpress/ &&
            sudo cp /home/bitnami/landing/*.png /opt/bitnami/wordpress/ 2>/dev/null || echo '‚ö†Ô∏è Algunos archivos PNG no encontrados' &&
            echo 'üìÅ Copiando archivos de noticias a WordPress...' &&
            sudo mkdir -p /opt/bitnami/wordpress/css /opt/bitnami/wordpress/js &&
            sudo cp -r /home/bitnami/landing/css/* /opt/bitnami/wordpress/css/ 2>/dev/null || echo '‚ö†Ô∏è No se pudieron copiar archivos CSS de noticias' &&
            sudo cp -r /home/bitnami/landing/js/* /opt/bitnami/wordpress/js/ 2>/dev/null || echo '‚ö†Ô∏è No se pudieron copiar archivos JS de noticias' &&
            sudo chown -R bitnami:daemon /opt/bitnami/wordpress/ &&
            echo 'üìÅ Archivos en Apache despu√©s de copiar:' &&
            ls -la /opt/bitnami/apache/htdocs/*.css &&
            echo 'üìÅ Archivos en WordPress despu√©s de copiar:' &&
            ls -la /opt/bitnami/wordpress/*.css &&
            echo 'üìÅ Archivos de noticias en WordPress:' &&
            ls -la /opt/bitnami/wordpress/css/ /opt/bitnami/wordpress/js/ 2>/dev/null || echo '‚ö†Ô∏è Directorios de noticias no encontrados en WordPress' &&
            echo 'üìÑ Verificando archivo de prueba:' &&
            cat /home/bitnami/landing/test-deployment.txt &&
            echo 'üìÑ Verificando footer de index.html (Apache):' &&
            tail -10 /opt/bitnami/apache/htdocs/index.html &&
            echo 'üìÑ Verificando footer de index.html (WordPress):' &&
            tail -10 /opt/bitnami/wordpress/index.html &&
            echo 'üìÑ Verificando que no hay isotipo en footer (WordPress):' &&
            grep -n 'isotipo-small.png' /opt/bitnami/wordpress/index.html || echo '‚úÖ No se encontr√≥ isotipo en WordPress index.html' &&
            echo 'üìÑ Verificando noticias.html en WordPress:' &&
            head -5 /opt/bitnami/wordpress/noticias.html &&
            echo '‚úÖ Archivos copiados exitosamente a Apache htdocs Y WordPress'
          "

      - name: Clear WordPress cache
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo 'üßπ Limpiando cache Apache y WordPress...' &&
            sudo rm -rf /opt/bitnami/apache/htdocs/wp-content/cache/* 2>/dev/null || true &&
            sudo rm -rf /opt/bitnami/apache/htdocs/wp-content/uploads/cache/* 2>/dev/null || true &&
            sudo rm -rf /opt/bitnami/apache/htdocs/wp-content/wpo-cache/* 2>/dev/null || true &&
            sudo rm -rf /opt/bitnami/wordpress/wp-content/cache/* 2>/dev/null || true &&
            sudo rm -rf /opt/bitnami/wordpress/wp-content/uploads/cache/* 2>/dev/null || true &&
            sudo rm -rf /opt/bitnami/wordpress/wp-content/wpo-cache/* 2>/dev/null || true &&
            echo 'üßπ Limpiando cache Redis...' &&
            redis-cli FLUSHALL 2>/dev/null || echo 'Redis no disponible' &&
            echo 'üßπ Limpiando cache WP-Optimize...' &&
            cd /opt/bitnami/wordpress &&
            wp wpo cache flush --allow-root 2>/dev/null || echo 'WP-Optimize no disponible' &&
            echo 'üîÑ Reiniciando servicios...' &&
            sudo /opt/bitnami/ctlscript.sh restart apache 2>/dev/null || true &&
            sudo /opt/bitnami/ctlscript.sh restart nginx 2>/dev/null || true &&
            sudo systemctl restart redis 2>/dev/null || echo 'Redis service no disponible' &&
            echo '‚úÖ Todos los caches limpiados y servicios reiniciados'
          "

      - name: Install Node.js dependencies
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            cd /home/bitnami/landing &&
            export PATH=\$PATH:/home/bitnami/.nvm/versions/node/v22.17.1/bin &&
            /home/bitnami/.nvm/versions/node/v22.17.1/bin/npm install &&
            echo '‚úÖ Dependencias instaladas'
          "

      - name: Create SQLite database file
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            cd /home/bitnami/landing &&
            touch chat_history.db &&
            chmod 666 chat_history.db &&
            echo '‚úÖ Base de datos creada'
          "

      - name: Stop existing backend (if running)
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            export PATH=\$PATH:/home/bitnami/.nvm/versions/node/v22.17.1/bin &&
            /home/bitnami/.nvm/versions/node/v22.17.1/bin/pm2 stop redjudicial-backend 2>/dev/null || echo 'Backend no estaba corriendo' &&
            echo '‚úÖ Backend anterior detenido'
          "

      - name: Start backend with pm2
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            cd /home/bitnami/landing &&
            export PATH=\$PATH:/home/bitnami/.nvm/versions/node/v22.17.1/bin &&
            /home/bitnami/.nvm/versions/node/v22.17.1/bin/pm2 start server.js --name redjudicial-backend --env production &&
            echo '‚úÖ Backend iniciado'
          "

      - name: Save pm2 configuration
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            export PATH=\$PATH:/home/bitnami/.nvm/versions/node/v22.17.1/bin &&
            /home/bitnami/.nvm/versions/node/v22.17.1/bin/pm2 save &&
            echo '‚úÖ Configuraci√≥n pm2 guardada'
          "

      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no bitnami@23.22.241.121 "
            echo '=== ‚úÖ VERIFICACI√ìN COMPLETA DE DEPLOY ===' &&
            echo 'üìÅ Archivos principales en WordPress:' &&
            ls -la /opt/bitnami/wordpress/*.html /opt/bitnami/wordpress/*.css /opt/bitnami/wordpress/*.js 2>/dev/null || echo '‚ö†Ô∏è Algunos archivos principales no encontrados' &&
            echo 'üìÅ Archivos de noticias en WordPress:' &&
            ls -la /opt/bitnami/wordpress/css/noticias.css /opt/bitnami/wordpress/js/noticias.js /opt/bitnami/wordpress/noticias.html 2>/dev/null || echo '‚ö†Ô∏è Archivos de noticias no encontrados' &&
            echo 'üìÑ Verificando noticias.html:' &&
            grep -n 'noticias.css' /opt/bitnami/wordpress/noticias.html || echo '‚ö†Ô∏è CSS de noticias no referenciado' &&
            grep -n 'noticias.js' /opt/bitnami/wordpress/noticias.html || echo '‚ö†Ô∏è JS de noticias no referenciado' &&
            echo 'üìÑ Contenido del footer (√∫ltimas 10 l√≠neas):' &&
            tail -10 /opt/bitnami/wordpress/index.html &&
            echo 'üìÑ Verificando chat-widget.js:' &&
            grep -n 'studentPlansInfo' /opt/bitnami/wordpress/chat-widget.js || echo '‚ö†Ô∏è Info de planes no encontrada' &&
            echo 'üîÑ Estado del backend:' &&
            export PATH=\$PATH:/home/bitnami/.nvm/versions/node/v22.17.1/bin &&
            /home/bitnami/.nvm/versions/node/v22.17.1/bin/pm2 status &&
            echo 'üìä Timestamps de archivos cr√≠ticos:' &&
            stat -c '%y %n' /opt/bitnami/wordpress/noticias.html /opt/bitnami/wordpress/css/noticias.css /opt/bitnami/wordpress/js/noticias.js 2>/dev/null || echo '‚ö†Ô∏è No se pudieron verificar timestamps' &&
            echo '‚úÖ Deploy completado exitosamente - TODOS los archivos incluidos'
          "

      - name: Purge Cloudflare cache
        run: |
          echo "üå©Ô∏è Purgando cache de Cloudflare..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/41a7ba1fa6bff0d03a8ee330f3142e1e/purge_cache" \
            -H "X-Auth-Email: nicolas.barriga@redjudicial.cl" \
            -H "X-Auth-Key: c2c39aca7709ff004afb6f7232d73d70ffbcc" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' || echo "‚ö†Ô∏è Error purgando cache de Cloudflare"
          echo "‚úÖ Cache de Cloudflare purgado"
