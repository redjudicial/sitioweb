# Red Judicial Landing - Chat Asistente

## üü¢ Widget de Chat con OpenAI (Asistente Red Judicial)

### 1. Backend seguro (Node.js/Express)

- El backend est√° en `server.js` y usa tu API Key de OpenAI y el ID del asistente.
- **No expone credenciales al frontend.**

#### **Pasos para correr el backend:**

1. Instala dependencias:
   ```bash
   cd landing
   npm install express cors body-parser axios dotenv
   ```
2. Aseg√∫rate de tener el archivo `APIS_Y_CREDENCIALES.env` con tu API Key y configuraci√≥n.
3. Ejecuta el servidor:
   ```bash
   node server.js
   ```
   Por defecto corre en el puerto 3001. Puedes cambiarlo con la variable de entorno `PORT`.

---

### 2. Widget frontend (chat-widget.js)

- El widget est√° en `chat-widget.js`.
- Es autocontenible, minimalista y acorde al branding Red Judicial.
- **No tiene sonido.**

#### **Integraci√≥n:**

1. Copia el archivo `chat-widget.js` en la carpeta `landing/` (ya est√° incluido).
2. En los archivos `index.html` y `estudiantes.html`, agrega antes de `</body>`:
   ```html
   <script src="chat-widget.js"></script>
   ```
3. El widget solo aparecer√° en estas dos p√°ginas.

---

### 3. Prueba local

- Corre el backend (`node server.js`)
- Abre `index.html` o `estudiantes.html` en tu navegador (puedes usar Live Server o similar)
- Haz clic en la burbuja verde "¬øTienes Dudas?" y prueba el chat

---

### 4. Despliegue en producci√≥n

- Sube el backend a tu servidor (puede ser Node.js en VPS, Docker, o serverless)
- Aseg√∫rate de que el endpoint `/api/chat` sea accesible desde el frontend
- El widget funcionar√° autom√°ticamente en las p√°ginas indicadas

---

### 5. Personalizaci√≥n

- El color, texto y branding se pueden ajustar en la parte superior de `chat-widget.js`
- Si cambias la ruta del backend, ajusta la variable `API_URL` en el widget

---

## üîß Deploy y Configuraci√≥n de Servidor

### üìç Arquitectura de Deploy

**El sitio www.redjudicial.cl utiliza una configuraci√≥n espec√≠fica:**

- **GitHub Repository**: `redjudicial/sitioweb` (rama `main`)
- **Servidor**: AWS Lightsail (`23.22.241.121`)
- **Usuario SSH**: `bitnami` con key `~/.ssh/LightsailDefaultKey-us-east-1.pem`
- **CDN**: Cloudflare (cachea contenido est√°tico)

### üöÄ GitHub Actions - Deploy Autom√°tico

El archivo `.github/workflows/deploy.yml` maneja el deploy autom√°tico:

1. **Deploy a staging**: `/home/bitnami/landing/` (para backend Node.js)
2. **Deploy a producci√≥n**: `/opt/bitnami/wordpress/` (directorio que sirve www.redjudicial.cl)

**¬øPor qu√© dos directorios?**
- WordPress sirve el dominio principal desde `/opt/bitnami/wordpress/`
- El backend de Node.js/PM2 corre desde `/home/bitnami/landing/`

### üé® Sistema de CSS Separados

**Arquitectura de estilos independientes:**

- **`styles.css`** ‚Üí Solo para `index.html` (landing principal para abogados)
- **`estudiantes.css`** ‚Üí Solo para `estudiantes.html` (landing para estudiantes)

**Beneficios:**
- ‚úÖ Evita conflictos entre p√°ginas
- ‚úÖ Optimizaci√≥n espec√≠fica por audiencia
- ‚úÖ Mantenimiento m√°s f√°cil
- ‚úÖ Carga m√°s r√°pida (solo el CSS necesario)

---

## üîê CONFIGURACI√ìN DE GITHUB ACTIONS - PROBLEMA RESUELTO

### ‚ö†Ô∏è PROBLEMA CR√çTICO: Token de GitHub Incorrecto

**Fecha del problema:** 24 de Julio 2025  
**Estado:** ‚úÖ RESUELTO

#### üîç DIAGN√ìSTICO DEL PROBLEMA:

El chat widget no aparec√≠a en la posici√≥n correcta en `estudiantes.html` debido a un problema de autenticaci√≥n en GitHub Actions.

**S√≠ntomas:**
- ‚úÖ GitHub Action se ejecutaba correctamente
- ‚úÖ Archivos se sub√≠an a GitHub
- ‚ùå Archivos NO se copiaban al servidor
- ‚ùå CSS no se actualizaba en producci√≥n
- ‚ùå Chat widget aparec√≠a en posici√≥n incorrecta

#### üõ†Ô∏è CAUSA RA√çZ:

**Token de GitHub incorrecto** - Se estaba usando el token de la cuenta **docemonos** en lugar del token de la cuenta **redjudicial**.

**Permisos comparados:**

**Token docemonos (INCORRECTO):**
```json
"permissions": {
  "admin": false,
  "maintain": false,
  "push": false,
  "triage": false,
  "pull": true
}
```

**Token redjudicial (CORRECTO):**
```json
"permissions": {
  "admin": true,
  "maintain": true,
  "push": true,
  "triage": true,
  "pull": true
}
```

#### ‚úÖ SOLUCI√ìN APLICADA:

1. **Identificar el token correcto:** Token de la cuenta propietaria del repositorio
2. **Actualizar `APIS_Y_CREDENCIALES.env`:**
   ```bash
   GITHUB_TOKEN=TU_TOKEN_DE_REDJUDICIAL_AQUI
   ```
3. **Verificar permisos de administrador**
4. **Forzar nuevo deployment con cache busting**

#### üö® PREVENCI√ìN PARA EL FUTURO:

**Siempre verificar:**
1. **Token de GitHub:** Debe ser de la cuenta propietaria del repositorio
2. **Permisos:** Debe tener `admin: true` para acceder a secrets
3. **Secrets:** `DEPLOY_KEY` debe estar configurado correctamente
4. **Cache:** Usar par√°metros de cache busting (`?v=X.X`) para forzar actualizaciones

#### üìã COMANDOS DE VERIFICACI√ìN:

```bash
# Verificar token de GitHub
curl -H "Authorization: token TU_TOKEN" "https://api.github.com/repos/redjudicial/sitioweb"

# Verificar permisos
curl -H "Authorization: token TU_TOKEN" "https://api.github.com/repos/redjudicial/sitioweb" | grep -o '"permissions":[^}]*'

# Verificar secrets
curl -H "Authorization: token TU_TOKEN" "https://api.github.com/repos/redjudicial/sitioweb/actions/secrets"

# Verificar deployment
curl -s "https://www.redjudicial.cl/estudiantes.css?v=X.X" | grep "VERSION"
```

#### üéØ RESULTADO FINAL:

- ‚úÖ **Chat widget funciona correctamente**
- ‚úÖ **Aparece en posici√≥n correcta (esquina inferior derecha)**
- ‚úÖ **GitHub Action funciona perfectamente**
- ‚úÖ **Deployment autom√°tico funcionando**
- ‚úÖ **CSS se actualiza correctamente**

**Lecci√≥n aprendida:** El problema estaba en la autenticaci√≥n de GitHub, no en el c√≥digo.

**Reglas importantes:**
- Cambios en `styles.css` NO afectan `estudiantes.html`
- Cambios en `estudiantes.css` NO afectan `index.html`
- Cada p√°gina carga solo su CSS espec√≠fico

### üóÇÔ∏è Estructura en Servidor

```bash
# WordPress (frontend p√∫blico):
/opt/bitnami/wordpress/
‚îú‚îÄ‚îÄ index.html          # Landing principal (abogados)
‚îú‚îÄ‚îÄ estudiantes.html    # Landing para estudiantes
‚îú‚îÄ‚îÄ styles.css          # CSS para index.html
‚îú‚îÄ‚îÄ estudiantes.css     # CSS para estudiantes.html
‚îú‚îÄ‚îÄ script.js           # JavaScript del landing
‚îî‚îÄ‚îÄ chat-widget.js      # Widget de chat

# Node.js Backend (API):
/home/bitnami/landing/
‚îú‚îÄ‚îÄ server.js           # Servidor Express
‚îú‚îÄ‚îÄ package.json        # Dependencias
‚îî‚îÄ‚îÄ node_modules/       # M√≥dulos de Node.js
```

### ‚ö†Ô∏è Problemas Comunes y Soluciones

#### 1. **Cambios CSS no se ven en www.redjudicial.cl**
**Problema**: Cloudflare cachea el CSS antiguo
**Soluci√≥n**:
```bash
# Limpiar cache espec√≠fico
curl -X POST "https://api.cloudflare.com/client/v4/zones/41a7ba1fa6bff0d03a8ee330f3142e1e/purge_cache" \
  -H "X-Auth-Email: nicolas.barriga@redjudicial.cl" \
  -H "X-Auth-Key: c2c39aca7709ff004afb6f7232d73d70ffbcc" \
  -H "Content-Type: application/json" \
  --data '{"files":["https://www.redjudicial.cl/styles.css"]}'
```

#### 2. **Deploy autom√°tico no actualiza el frontend**
**Problema**: GitHub Actions desplegaba solo a `/home/bitnami/landing/`
**Soluci√≥n**: ‚úÖ **Ya corregido** - Ahora copia archivos a ambos directorios

#### 3. **Conflictos CSS entre reglas**
**Problema resuelto**: `.comparison-section` ten√≠a reglas CSS conflictivas
**Soluci√≥n aplicada**: Sistema de CSS separados
- `styles.css` ‚Üí Solo para index.html  
- `estudiantes.css` ‚Üí Solo para estudiantes.html

#### 4. **Cambios CSS no se ven en una p√°gina espec√≠fica**
**Problema**: Modificar CSS incorrecto para la p√°gina objetivo
**Soluci√≥n**: Verificar qu√© archivo CSS editar:
```bash
# Para index.html (abogados):
nano styles.css

# Para estudiantes.html:
nano estudiantes.css
```

#### 5. **GitHub Actions no actualiza archivos en producci√≥n**
**Problema**: Los archivos locales est√°n actualizados pero el servidor muestra versi√≥n antigua
**Causa identificada**: 
- Paso problem√°tico en `.github/workflows/deploy.yml` l√≠nea 35
- Directorio `/home/bitnami/landing/landing/` no existe
- Comandos con `|| true` ocultan errores de copia
**S√≠ntomas**: 
- T√≠tulo antiguo en el navegador
- Colores antiguos
- CSS no actualizado
**Soluci√≥n aplicada**: ‚úÖ **Arreglado en commit 6d41adb**
- Eliminado paso problem√°tico de copia a subdirectorio inexistente
- Mejorado comando de copia con verificaci√≥n expl√≠cita
- Agregado paso de verificaci√≥n del deploy

**‚ö†Ô∏è PREVENCI√ìN PARA QUE NO VUELVA A OCURRIR:**

1. **Nunca usar `|| true` en comandos cr√≠ticos** - Oculta errores importantes
2. **Verificar que los directorios existen** antes de copiar archivos
3. **Siempre incluir pasos de verificaci√≥n** en el deploy
4. **Monitorear los logs del GitHub Action** despu√©s de cada push
5. **Verificar timestamps de archivos** en servidor despu√©s del deploy

**üîç MONITOREO POST-DEPLOY:**
```bash
# Verificar que archivos se actualizaron
ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121 "ls -la /opt/bitnami/wordpress/*.css /opt/bitnami/wordpress/*.html"

# Verificar que backend est√° corriendo
ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121 "pm2 status"

# Verificar que cambios se ven en el sitio
curl -s "https://www.redjudicial.cl/estudiantes.html" | grep -o "chat-widget.js[^\"']*"
```
**Soluci√≥n de emergencia** (si vuelve a fallar):
```bash
# Copiar manualmente el archivo problem√°tico
scp -i ~/.ssh/LightsailDefaultKey-us-east-1.pem estudiantes.html bitnami@23.22.241.121:/opt/bitnami/wordpress/

# Verificar que se copi√≥ correctamente
ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121 "head -5 /opt/bitnami/wordpress/estudiantes.html"
```

### üîß Comandos √ötiles de Administraci√≥n

```bash
# Conectar por SSH
ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121

# Verificar archivos en WordPress
ls -la /opt/bitnami/wordpress/*.css

# Verificar backend Node.js
pm2 status
pm2 logs redjudicial-backend

# Deploy manual (si GitHub Actions falla)
scp -i ~/.ssh/LightsailDefaultKey-us-east-1.pem *.html *.css *.js bitnami@23.22.241.121:/home/bitnami/landing/
ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121 "sudo cp /home/bitnami/landing/*.html /home/bitnami/landing/*.css /home/bitnami/landing/*.js /opt/bitnami/wordpress/"

# Purgar cache de Cloudflare (todo el sitio)
curl -X POST "https://api.cloudflare.com/client/v4/zones/41a7ba1fa6bff0d03a8ee330f3142e1e/purge_cache" \
  -H "X-Auth-Email: nicolas.barriga@redjudicial.cl" \
  -H "X-Auth-Key: c2c39aca7709ff004afb6f7232d73d70ffbcc" \
  -H "Content-Type: application/json" \
  --data '{"purge_everything":true}'
```

### üìã Checklist de Deploy

Cuando haces cambios al landing:

1. ‚úÖ **Commit y push** a rama `main`
2. ‚úÖ **GitHub Actions** despliega autom√°ticamente
3. ‚úÖ **Verificar** que archivos llegaron a ambos directorios
4. ‚ö†Ô∏è **Si no se ven cambios**: Limpiar cache de Cloudflare
5. ‚úÖ **Confirmar** en www.redjudicial.cl

### üîç Checklist de Verificaci√≥n Post-Deploy (OBLIGATORIO)

**Despu√©s de cada `git push`, verificar:**

1. **‚úÖ GitHub Action complet√≥ exitosamente**
   - Ir a GitHub ‚Üí Actions ‚Üí Verificar que el √∫ltimo deploy fue exitoso
   - Revisar logs si hay errores

2. **‚úÖ Archivos actualizados en servidor**
   ```bash
   ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121 "ls -la /opt/bitnami/wordpress/*.css /opt/bitnami/wordpress/*.html"
   ```
   - Verificar que timestamps son recientes (mismo d√≠a)

3. **‚úÖ Backend funcionando**
   ```bash
   ssh -i ~/.ssh/LightsailDefaultKey-us-east-1.pem bitnami@23.22.241.121 "pm2 status"
   ```
   - Debe mostrar `redjudicial-backend` como `online`

4. **‚úÖ Chat funcionando**
   ```bash
   curl -s "https://www.redjudicial.cl/api/chat" -X POST -H "Content-Type: application/json" -d '{"message":"test"}'
   ```
   - Debe devolver respuesta JSON v√°lida

5. **‚úÖ Cambios visibles en el sitio**
   - Abrir https://www.redjudicial.cl/estudiantes.html
   - Verificar que cambios se ven correctamente

**üö® SI ALGUNO FALLA:**
- Revisar logs del GitHub Action
- Usar soluci√≥n de emergencia manual
- Reportar problema inmediatamente

### ‚ö†Ô∏è SE√ëALES DE ADVERTENCIA (PROBLEMA INMINENTE)

**Si ves estos s√≠ntomas, el GitHub Action est√° fallando:**

1. **üîÑ GitHub Action se ejecuta pero archivos no se actualizan**
   - Timestamps de archivos en servidor son antiguos
   - Cambios no aparecen en el sitio

2. **üìÅ Directorios inexistentes en comandos**
   - Errores sobre `/home/bitnami/landing/landing/`
   - Comandos que fallan silenciosamente

3. **ü§ê Comandos con `|| true` en logs**
   - Errores ocultos en el deploy
   - Deploy "exitoso" pero archivos no actualizados

4. **üîÑ Backend no responde despu√©s del deploy**
   - Chat no funciona
   - API retorna errores

**üéØ ACCI√ìN INMEDIATA:**
- Revisar `.github/workflows/deploy.yml` por comandos problem√°ticos
- Verificar que todos los directorios referenciados existen
- Eliminar `|| true` de comandos cr√≠ticos
- Agregar pasos de verificaci√≥n expl√≠cita

### üÜò Contacto de Emergencia

Si algo falla en el deploy o el sitio est√° ca√≠do:
- **SSH**: Acceso directo al servidor con credenciales en `APIS_Y_CREDENCIALES.env`
- **Cloudflare**: Dashboard para gestionar DNS y cache
- **PM2**: Para reiniciar backend si es necesario

---

¬øDudas? Contacta a tu desarrollador o al equipo de Red Judicial. 